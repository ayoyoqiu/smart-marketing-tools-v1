# 👥 用户角色功能对比（v1.0.1版本）

## 📋 三种用户角色

| 角色 | 英文名称 | 权限级别 | 说明 |
|------|---------|---------|------|
| **普通用户** | `user` | ⭐ 基础 | 只能管理自己的数据 |
| **管理员** | `admin` | ⭐⭐ 中级 | 可管理所有用户数据 + 部分管理功能 |
| **超级管理员** | `super_admin` | ⭐⭐⭐ 最高 | 拥有所有权限 |

---

## 🔐 权限继承关系

```
super_admin (超级管理员)
    ↓ 自动拥有
    ├─ super_admin 权限
    ├─ admin 权限
    └─ user 权限

admin (管理员)
    ↓ 自动拥有
    ├─ admin 权限
    └─ user 权限

user (普通用户)
    └─ user 权限
```

---

## 🎯 功能权限对比表

### 1. 导航菜单访问权限

| 菜单项 | 普通用户 | 管理员 | 超级管理员 | 路径 |
|--------|---------|--------|-----------|------|
| **首页** | ✅ | ✅ | ✅ | `/` |
| **数据看板** | ✅ | ✅ | ✅ | `/dashboard` |
| **任务管理** | ✅ | ✅ | ✅ | `/tasks` |
| **地址管理** | ✅ | ✅ | ✅ | `/address` |
| **消息历史** | ✅ | ✅ | ✅ | `/history` |
| **图片URL工具** | ✅ | ✅ | ✅ | `/image-tools` |
| **个人资料** | ✅ | ✅ | ✅ | `/profile` |
| **管理面板** | ❌ | ✅ | ✅ | `/admin` |
| **账号管理** | ❌ | ✅ | ✅ | `/admin/accounts` |

---

### 2. 数据访问权限

#### 📊 数据看板
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 查看任务统计 | ✅ 仅自己的 | ✅ 所有用户的 | ✅ 所有用户的 |
| 查看消息统计 | ✅ 仅自己的 | ✅ 所有用户的 | ✅ 所有用户的 |
| 查看地址统计 | ✅ 仅自己的 | ✅ 所有用户的 | ✅ 所有用户的 |

#### 📝 任务管理
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 创建任务 | ✅ | ✅ | ✅ |
| 编辑任务 | ✅ 仅自己的 | ✅ 所有任务 | ✅ 所有任务 |
| 删除任务 | ✅ 仅自己的 | ✅ 所有任务 | ✅ 所有任务 |
| 查看任务列表 | ✅ 仅自己的 | ✅ 所有任务 | ✅ 所有任务 |
| 立即发送 | ✅ | ✅ | ✅ |
| 定时发送 | ✅ | ✅ | ✅ |

#### 🏠 地址管理
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 查看Webhook地址 | ✅ 仅自己的 | ✅ 所有地址 | ✅ 所有地址 |
| 添加Webhook地址 | ✅ | ✅ | ✅ |
| 编辑Webhook地址 | ✅ 仅自己的 | ✅ 所有地址 | ✅ 所有地址 |
| 删除Webhook地址 | ✅ 仅自己的 | ✅ 所有地址 | ✅ 所有地址 |
| 查看分组 | ✅ 自己的+系统分组 | ✅ 所有分组 | ✅ 所有分组 |
| 创建分组 | ✅ | ✅ | ✅ |
| 管理分组 | ✅ 仅自己的 | ✅ 所有分组 | ✅ 所有分组 |

#### 📜 消息历史
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 查看消息记录 | ✅ 仅自己的 | ✅ 所有消息 | ✅ 所有消息 |
| 筛选消息 | ✅ | ✅ | ✅ |
| 重发消息 | ✅ 仅自己的 | ✅ 所有消息 | ✅ 所有消息 |
| 查看详情 | ✅ | ✅ | ✅ |

#### 🖼️ 图片URL工具
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 上传图片 | ✅ | ✅ | ✅ |
| 生成链接 | ✅ | ✅ | ✅ |
| 查看历史 | ✅ 仅自己的 | ✅ 所有图片 | ✅ 所有图片 |
| 删除图片 | ✅ 仅自己的 | ✅ 所有图片 | ✅ 所有图片 |

---

### 3. 管理功能（仅管理员）

#### 👑 管理面板
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 访问管理面板 | ❌ | ✅ | ✅ |
| 查看系统统计 | ❌ | ✅ | ✅ |
| 用户管理 | ❌ | ✅ | ✅ |
| 系统设置 | ❌ | ✅ | ✅ |

#### 👤 账号管理
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 查看所有用户 | ❌ | ✅ | ✅ |
| 创建用户 | ❌ | ✅ | ✅ |
| 编辑用户信息 | ❌ | ✅ | ✅ |
| 禁用/启用用户 | ❌ | ✅ | ✅ |
| 分配角色 | ❌ | ✅ | ✅ |
| 重置密码 | ❌ | ✅ | ✅ |
| 删除用户 | ❌ | ⚠️ 有限制 | ✅ |

---

### 4. 个人功能

#### 👨‍💼 个人资料
| 功能 | 普通用户 | 管理员 | 超级管理员 |
|------|---------|--------|-----------|
| 查看个人信息 | ✅ | ✅ | ✅ |
| 修改昵称 | ✅ | ✅ | ✅ |
| 修改密码 | ✅ | ✅ | ✅ |
| 修改邮箱 | ✅ | ✅ | ✅ |
| 查看登录历史 | ✅ | ✅ | ✅ |
| 角色切换 | ❌ | ✅ | ✅ |

---

## 🔒 关键权限判断逻辑

### 代码层面的权限检查

#### 1. 管理员判断函数
```javascript
const isAdmin = () => {
  return currentRole === 'admin' || currentRole === 'super_admin';
};
```

#### 2. 地址管理数据过滤
```javascript
// 普通用户只能看到自己的数据
if (isAdmin()) {
  // 管理员可以看到所有webhook
} else {
  query = query.eq('user_id', user?.id)
}
```

#### 3. 分组管理数据过滤
```javascript
// 普通用户只能看到自己的分组和系统分组
if (isAdmin()) {
  // 管理员可以看到所有分组
} else {
  query = query.or(`user_id.eq.${user.id},user_id.is.null`)
}
```

#### 4. 侧边栏菜单控制
```javascript
// 如果用户是管理员，添加管理员菜单
if (isAdmin()) {
  adminItems = [
    { key: '/admin', label: '管理面板' },
    { key: '/admin/accounts', label: '账号管理' }
  ];
}
```

---

## 📊 数据隔离规则

### 🔐 RLS（行级安全策略）

| 表名 | 普通用户 | 管理员 | 说明 |
|------|---------|--------|------|
| **tasks** | 仅自己的 | 所有数据 | 基于 `user_id` 过滤 |
| **webhooks** | 仅自己的 | 所有数据 | 基于 `user_id` 过滤 |
| **groups** | 自己的+系统分组 | 所有数据 | `user_id=self OR user_id IS NULL` |
| **message_history** | 仅自己的 | 所有数据 | 基于 `user_id` 过滤 |
| **image_uploads** | 仅自己的 | 所有数据 | 基于 `user_id` 过滤 |

---

## 🎭 角色切换功能

### 适用对象
- ✅ **管理员**：可在 user ↔ admin 之间切换
- ✅ **超级管理员**：可在 user ↔ admin ↔ super_admin 之间切换
- ❌ **普通用户**：无法切换角色

### 切换场景
- 管理员想以普通用户视角查看数据
- 测试不同角色的功能
- 临时降低权限避免误操作

### 切换位置
- 个人资料页面的"角色切换"选项

---

## 💡 典型使用场景

### 🙋 普通用户场景
```
张三（普通用户）：
1. 登录系统
2. 创建自己的Webhook地址
3. 创建推送任务并发送
4. 查看自己的消息历史
5. 上传图片生成URL链接
✅ 只能看到和操作自己的数据
```

### 👨‍💼 管理员场景
```
李四（管理员）：
1. 登录系统（自动获得最高权限）
2. 查看所有用户的任务和地址
3. 帮助用户排查问题
4. 管理用户账号
5. 查看系统统计数据
✅ 可以看到和管理所有用户数据
✅ 可以切换到普通用户视角
```

### 👑 超级管理员场景
```
王五（超级管理员）：
1. 拥有系统所有权限
2. 可以管理管理员账号
3. 可以执行高危操作
4. 系统配置和维护
✅ 拥有最高权限
✅ 可以在三种角色间切换
```

---

## ⚠️ 安全提示

### 普通用户
- ✅ 数据完全隔离，互不影响
- ✅ 无法查看其他用户数据
- ✅ 无法执行管理操作

### 管理员
- ⚠️ 可以查看所有用户数据
- ⚠️ 可以修改其他用户的配置
- ⚠️ 需要谨慎操作避免误删

### 超级管理员
- 🚨 拥有最高权限
- 🚨 可执行不可逆操作
- 🚨 建议日常使用时切换到较低权限

---

## 📝 角色管理说明

### 如何分配角色？

1. **默认角色**：新注册用户自动分配 `user` 角色
2. **提升权限**：由管理员在"账号管理"中分配
3. **多角色**：一个用户可以拥有多个角色
4. **自动继承**：高级角色自动继承低级角色权限

### 角色存储位置

- **users表**：`role` 字段（主角色）
- **user_roles表**：`role` 字段（多角色支持）
- 系统会自动合并两个表的角色

---

## 🔍 如何查看自己的角色？

### 方法1：查看个人资料页面
```
登录 → 左侧菜单 → 个人资料 → 查看"当前角色"
```

### 方法2：查看Header右上角
```
右上角显示当前登录用户和角色
```

### 方法3：查看侧边栏菜单
```
如果能看到"管理员功能"菜单项 → 您是管理员
如果看不到 → 您是普通用户
```

---

**文档版本**: v1.0.1
**最后更新**: 2025-10-24
**适用版本**: 当前稳定版本（回滚后）

